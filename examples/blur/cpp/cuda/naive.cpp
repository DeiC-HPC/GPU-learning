#include <timer.h>
#include <bmp.h>

#define T 32

using namespace std;

#define FILTER_SIZE 25
__device__ float filter[FILTER_SIZE][FILTER_SIZE] = {
  {0.00002089601700461484, 0.00003305036622095982, 0.00005023131340425048, 0.00007335984106397632, 0.00010295036874283779, 0.00013882995593377464, 0.00017989715219067997, 0.00022400167921848203, 0.0002680181425913838, 0.00030815064933437607, 0.00034044580606500813, 0.00036142560780284746, 0.00036870234151190355, 0.00036142560780284746, 0.00034044580606500813, 0.0003081506493343761, 0.0002680181425913839, 0.0002240016792184821, 0.00017989715219067997, 0.00013882995593377466, 0.00010295036874283785, 0.0000733598410639763, 0.0000502313134042505, 0.000033050366220959825, 0.000020896017004614847},
  {0.00003305036622095982, 0.000052274397895939865, 0.00007944879176752406, 0.00011603022779606098, 0.0001628323421053016, 0.00021958160184486984, 0.0002845358883799065, 0.0003542941954270895, 0.000423913215832011, 0.0004873891426044721, 0.0005384690568711459, 0.0005716519419408502, 0.0005831612508164887, 0.0005716519419408502, 0.0005384690568711459, 0.0004873891426044722, 0.0004239132158320112, 0.0003542941954270896, 0.0002845358883799065, 0.0002195816018448699, 0.0001628323421053017, 0.00011603022779606096, 0.00007944879176752409, 0.00005227439789593988, 0.00003305036622095983},
  {0.00005023131340425048, 0.00007944879176752406, 0.00012074955939013615, 0.00017634753871787064, 0.00024747932758011065, 0.000333729199438707, 0.0004324494103458333, 0.0005384709703010386, 0.0006442808366570358, 0.0007407541752583697, 0.0008183875414074067, 0.0008688202624383913, 0.0008863125860433226, 0.0008688202624383913, 0.0008183875414074067, 0.0007407541752583698, 0.0006442808366570361, 0.0005384709703010387, 0.0004324494103458333, 0.0003337291994387071, 0.00024747932758011076, 0.00017634753871787062, 0.00012074955939013619, 0.00007944879176752408, 0.0000502313134042505},
  {0.00007335984106397632, 0.00011603022779606098, 0.00017634753871787064, 0.00025754507568324323, 0.00036142881616072576, 0.00048739161630521785, 0.0006315666038008901, 0.0007864047766568393, 0.0009409337836212422, 0.001081827347955281, 0.0011952062547762386, 0.0012688602396816744, 0.0012944067363294968, 0.0012688602396816744, 0.0011952062547762386, 0.0010818273479552812, 0.0009409337836212427, 0.0007864047766568395, 0.0006315666038008901, 0.000487391616305218, 0.000361428816160726, 0.0002575450756832432, 0.0001763475387178707, 0.00011603022779606101, 0.00007335984106397635},
  {0.00010295036874283779, 0.0001628323421053016, 0.00024747932758011065, 0.00036142881616072576, 0.0005072152469030608, 0.0006839865775749289, 0.0008863161888567905, 0.001103610102799237, 0.0013204701452654676, 0.0015181947339683295, 0.0016773063145768272, 0.001780669473430746, 0.001816520440551672, 0.001780669473430746, 0.0016773063145768272, 0.00151819473396833, 0.0013204701452654683, 0.0011036101027992375, 0.0008863161888567905, 0.000683986577574929, 0.000507215246903061, 0.00036142881616072566, 0.0002474793275801107, 0.00016283234210530165, 0.00010295036874283783},
  {0.00013882995593377464, 0.00021958160184486984, 0.000333729199438707, 0.00048739161630521785, 0.0006839865775749289, 0.000922365092846031, 0.0011952092930307221, 0.0014882330564779608, 0.0017806717384081583, 0.0020473060037521735, 0.0022618701087104443, 0.002401256717657036, 0.0024496022286674335, 0.002401256717657036, 0.0022618701087104443, 0.002047306003752174, 0.0017806717384081592, 0.0014882330564779612, 0.0011952092930307221, 0.0009223650928460312, 0.0006839865775749293, 0.0004873916163052178, 0.0003337291994387071, 0.0002195816018448699, 0.0001388299559337747},
  {0.00017989715219067997, 0.0002845358883799065, 0.0004324494103458333, 0.0006315666038008901, 0.0008863161888567905, 0.0011952092930307221, 0.00154876335328256, 0.0019284662798865248, 0.0023074110524018625, 0.002652918221148093, 0.0029309523902488026, 0.0031115708586070957, 0.0031742174228408444, 0.0031115708586070957, 0.0029309523902488026, 0.002652918221148094, 0.0023074110524018638, 0.0019284662798865252, 0.00154876335328256, 0.0011952092930307225, 0.000886316188856791, 0.00063156660380089, 0.00043244941034583344, 0.00028453588837990657, 0.00017989715219068005},
  {0.00022400167921848203, 0.0003542941954270895, 0.0005384709703010386, 0.0007864047766568393, 0.001103610102799237, 0.0014882330564779608, 0.0019284662798865248, 0.0024012591625293136, 0.002873108018060552, 0.0033033215319417833, 0.003649520012575102, 0.0038744198496066745, 0.0039524251732860295, 0.0038744198496066745, 0.003649520012575102, 0.003303321531941784, 0.002873108018060553, 0.0024012591625293144, 0.0019284662798865248, 0.001488233056477961, 0.0011036101027992377, 0.0007864047766568392, 0.0005384709703010387, 0.00035429419542708956, 0.00022400167921848212},
  {0.0002680181425913838, 0.000423913215832011, 0.0006442808366570358, 0.0009409337836212422, 0.0013204701452654676, 0.0017806717384081583, 0.0023074110524018625, 0.002873108018060552, 0.003437675454718046, 0.003952426180294958, 0.004366652868554736, 0.0046357456575043905, 0.0047290790737435995, 0.0046357456575043905, 0.004366652868554736, 0.003952426180294958, 0.0034376754547180478, 0.0028731080180605527, 0.0023074110524018625, 0.0017806717384081588, 0.0013204701452654685, 0.000940933783621242, 0.000644280836657036, 0.0004239132158320111, 0.0002680181425913839},
  {0.00030815064933437607, 0.0004873891426044721, 0.0007407541752583697, 0.001081827347955281, 0.0015181947339683295, 0.0020473060037521735, 0.002652918221148093, 0.0033033215319417833, 0.003952426180294958, 0.004544254661748533, 0.005020506835294424, 0.0053298930464079535, 0.005437202023854888, 0.0053298930464079535, 0.005020506835294424, 0.004544254661748534, 0.00395242618029496, 0.0033033215319417846, 0.002652918221148093, 0.002047306003752174, 0.0015181947339683304, 0.0010818273479552807, 0.0007407541752583699, 0.0004873891426044722, 0.0003081506493343762},
  {0.00034044580606500813, 0.0005384690568711459, 0.0008183875414074067, 0.0011952062547762386, 0.0016773063145768272, 0.0022618701087104443, 0.0029309523902488026, 0.003649520012575102, 0.004366652868554736, 0.005020506835294424, 0.005546671733740268, 0.005888482592342909, 0.006007037887955125, 0.005888482592342909, 0.005546671733740268, 0.005020506835294425, 0.004366652868554739, 0.0036495200125751027, 0.0029309523902488026, 0.002261870108710445, 0.001677306314576828, 0.0011952062547762384, 0.000818387541407407, 0.000538469056871146, 0.00034044580606500824},
  {0.00036142560780284746, 0.0005716519419408502, 0.0008688202624383913, 0.0012688602396816744, 0.001780669473430746, 0.002401256717657036, 0.0031115708586070957, 0.0038744198496066745, 0.0046357456575043905, 0.0053298930464079535, 0.005888482592342909, 0.006251357373360134, 0.006377218579494979, 0.006251357373360134, 0.005888482592342909, 0.005329893046407954, 0.004635745657504392, 0.0038744198496066754, 0.0031115708586070957, 0.0024012567176570363, 0.001780669473430747, 0.0012688602396816742, 0.0008688202624383915, 0.0005716519419408504, 0.0003614256078028476},
  {0.00036870234151190355, 0.0005831612508164887, 0.0008863125860433226, 0.0012944067363294968, 0.001816520440551672, 0.0024496022286674335, 0.0031742174228408444, 0.0039524251732860295, 0.0047290790737435995, 0.005437202023854888, 0.006007037887955125, 0.006377218579494979, 0.006505613802206324, 0.006377218579494979, 0.006007037887955125, 0.005437202023854889, 0.004729079073743602, 0.003952425173286031, 0.0031742174228408444, 0.002449602228667434, 0.0018165204405516731, 0.0012944067363294966, 0.0008863125860433228, 0.0005831612508164888, 0.0003687023415119037},
  {0.00036142560780284746, 0.0005716519419408502, 0.0008688202624383913, 0.0012688602396816744, 0.001780669473430746, 0.002401256717657036, 0.0031115708586070957, 0.0038744198496066745, 0.0046357456575043905, 0.0053298930464079535, 0.005888482592342909, 0.006251357373360134, 0.006377218579494979, 0.006251357373360134, 0.005888482592342909, 0.005329893046407954, 0.004635745657504392, 0.0038744198496066754, 0.0031115708586070957, 0.0024012567176570363, 0.001780669473430747, 0.0012688602396816742, 0.0008688202624383915, 0.0005716519419408504, 0.0003614256078028476},
  {0.00034044580606500813, 0.0005384690568711459, 0.0008183875414074067, 0.0011952062547762386, 0.0016773063145768272, 0.0022618701087104443, 0.0029309523902488026, 0.003649520012575102, 0.004366652868554736, 0.005020506835294424, 0.005546671733740268, 0.005888482592342909, 0.006007037887955125, 0.005888482592342909, 0.005546671733740268, 0.005020506835294425, 0.004366652868554739, 0.0036495200125751027, 0.0029309523902488026, 0.002261870108710445, 0.001677306314576828, 0.0011952062547762384, 0.000818387541407407, 0.000538469056871146, 0.00034044580606500824},
  {0.0003081506493343761, 0.0004873891426044722, 0.0007407541752583698, 0.0010818273479552812, 0.00151819473396833, 0.002047306003752174, 0.002652918221148094, 0.003303321531941784, 0.003952426180294958, 0.004544254661748534, 0.005020506835294425, 0.005329893046407954, 0.005437202023854889, 0.005329893046407954, 0.005020506835294425, 0.004544254661748535, 0.003952426180294961, 0.003303321531941785, 0.002652918221148094, 0.0020473060037521744, 0.0015181947339683308, 0.001081827347955281, 0.0007407541752583701, 0.0004873891426044723, 0.00030815064933437624},
  {0.0002680181425913839, 0.0004239132158320112, 0.0006442808366570361, 0.0009409337836212427, 0.0013204701452654683, 0.0017806717384081592, 0.0023074110524018638, 0.002873108018060553, 0.0034376754547180478, 0.00395242618029496, 0.004366652868554739, 0.004635745657504392, 0.004729079073743602, 0.004635745657504392, 0.004366652868554739, 0.003952426180294961, 0.0034376754547180495, 0.002873108018060554, 0.0023074110524018638, 0.0017806717384081594, 0.0013204701452654692, 0.0009409337836212425, 0.0006442808366570363, 0.0004239132158320113, 0.00026801814259138403},
  {0.0002240016792184821, 0.0003542941954270896, 0.0005384709703010387, 0.0007864047766568395, 0.0011036101027992375, 0.0014882330564779612, 0.0019284662798865252, 0.0024012591625293144, 0.0028731080180605527, 0.0033033215319417846, 0.0036495200125751027, 0.0038744198496066754, 0.003952425173286031, 0.0038744198496066754, 0.0036495200125751027, 0.003303321531941785, 0.002873108018060554, 0.002401259162529315, 0.0019284662798865252, 0.0014882330564779615, 0.0011036101027992382, 0.0007864047766568394, 0.0005384709703010388, 0.00035429419542708966, 0.0002240016792184822},
  {0.00017989715219067997, 0.0002845358883799065, 0.0004324494103458333, 0.0006315666038008901, 0.0008863161888567905, 0.0011952092930307221, 0.00154876335328256, 0.0019284662798865248, 0.0023074110524018625, 0.002652918221148093, 0.0029309523902488026, 0.0031115708586070957, 0.0031742174228408444, 0.0031115708586070957, 0.0029309523902488026, 0.002652918221148094, 0.0023074110524018638, 0.0019284662798865252, 0.00154876335328256, 0.0011952092930307225, 0.000886316188856791, 0.00063156660380089, 0.00043244941034583344, 0.00028453588837990657, 0.00017989715219068005},
  {0.00013882995593377466, 0.0002195816018448699, 0.0003337291994387071, 0.000487391616305218, 0.000683986577574929, 0.0009223650928460312, 0.0011952092930307225, 0.001488233056477961, 0.0017806717384081588, 0.002047306003752174, 0.002261870108710445, 0.0024012567176570363, 0.002449602228667434, 0.0024012567176570363, 0.002261870108710445, 0.0020473060037521744, 0.0017806717384081594, 0.0014882330564779615, 0.0011952092930307225, 0.0009223650928460314, 0.0006839865775749294, 0.0004873916163052179, 0.00033372919943870714, 0.00021958160184486994, 0.00013882995593377472},
  {0.00010295036874283785, 0.0001628323421053017, 0.00024747932758011076, 0.000361428816160726, 0.000507215246903061, 0.0006839865775749293, 0.000886316188856791, 0.0011036101027992377, 0.0013204701452654685, 0.0015181947339683304, 0.001677306314576828, 0.001780669473430747, 0.0018165204405516731, 0.001780669473430747, 0.001677306314576828, 0.0015181947339683308, 0.0013204701452654692, 0.0011036101027992382, 0.000886316188856791, 0.0006839865775749294, 0.0005072152469030614, 0.00036142881616072587, 0.00024747932758011087, 0.00016283234210530176, 0.0001029503687428379},
  {0.0000733598410639763, 0.00011603022779606096, 0.00017634753871787062, 0.0002575450756832432, 0.00036142881616072566, 0.0004873916163052178, 0.00063156660380089, 0.0007864047766568392, 0.000940933783621242, 0.0010818273479552807, 0.0011952062547762384, 0.0012688602396816742, 0.0012944067363294966, 0.0012688602396816742, 0.0011952062547762384, 0.001081827347955281, 0.0009409337836212425, 0.0007864047766568394, 0.00063156660380089, 0.0004873916163052179, 0.00036142881616072587, 0.0002575450756832431, 0.00017634753871787067, 0.00011603022779606098, 0.00007335984106397633},
  {0.0000502313134042505, 0.00007944879176752409, 0.00012074955939013619, 0.0001763475387178707, 0.0002474793275801107, 0.0003337291994387071, 0.00043244941034583344, 0.0005384709703010387, 0.000644280836657036, 0.0007407541752583699, 0.000818387541407407, 0.0008688202624383915, 0.0008863125860433228, 0.0008688202624383915, 0.000818387541407407, 0.0007407541752583701, 0.0006442808366570363, 0.0005384709703010388, 0.00043244941034583344, 0.00033372919943870714, 0.00024747932758011087, 0.00017634753871787067, 0.00012074955939013623, 0.0000794487917675241, 0.00005023131340425052},
  {0.000033050366220959825, 0.00005227439789593988, 0.00007944879176752408, 0.00011603022779606101, 0.00016283234210530165, 0.0002195816018448699, 0.00028453588837990657, 0.00035429419542708956, 0.0004239132158320111, 0.0004873891426044722, 0.000538469056871146, 0.0005716519419408504, 0.0005831612508164888, 0.0005716519419408504, 0.000538469056871146, 0.0004873891426044723, 0.0004239132158320113, 0.00035429419542708966, 0.00028453588837990657, 0.00021958160184486994, 0.00016283234210530176, 0.00011603022779606098, 0.0000794487917675241, 0.00005227439789593989, 0.00003305036622095984},
  {0.000020896017004614847, 0.00003305036622095983, 0.0000502313134042505, 0.00007335984106397635, 0.00010295036874283783, 0.0001388299559337747, 0.00017989715219068005, 0.00022400167921848212, 0.0002680181425913839, 0.0003081506493343762, 0.00034044580606500824, 0.0003614256078028476, 0.0003687023415119037, 0.0003614256078028476, 0.00034044580606500824, 0.00030815064933437624, 0.00026801814259138403, 0.0002240016792184822, 0.00017989715219068005, 0.00013882995593377472, 0.0001029503687428379, 0.00007335984106397633, 0.00005023131340425052, 0.00003305036622095984, 0.000020896017004614857},
};

__global__ void blur(const FloatPixel *pixels_in, FloatPixel *pixels_out, size_t width, size_t height) {
  int x = blockIdx.x * blockDim.x + threadIdx.x;
  int y = blockIdx.y * blockDim.y + threadIdx.y;

  if (x < width && y < height) {
    for(int dy = -FILTER_SIZE/2; dy <= FILTER_SIZE/2; dy++) {
      for(int dx = -FILTER_SIZE/2; dx <= FILTER_SIZE/2; dx++) {
        int ny = y + dy;
        int nx = x + dx;
        if (0 <= ny && ny < height && 0 <= nx && nx < width) {
          pixels_out[y * width + x].red += filter[dy+FILTER_SIZE/2][dx+FILTER_SIZE/2] * pixels_in[ny * width + nx].red;
          pixels_out[y * width + x].green += filter[dy+FILTER_SIZE/2][dx+FILTER_SIZE/2] * pixels_in[ny * width + nx].green;
          pixels_out[y * width + x].blue += filter[dy+FILTER_SIZE/2][dx+FILTER_SIZE/2] * pixels_in[ny * width + nx].blue;
        }
      }
    }
  }
}

int main() {
  Bmp bmp("../../butterfly.bmp");
  FloatImage im = bmp.get_pixel_data();
  
  size_t pixel_data_size = im.width * im.height * sizeof(FloatPixel);
  
  FloatPixel *device_pixels_in = nullptr;
  FloatPixel *device_pixels_out = nullptr;
  
  cudaMalloc((void**) &device_pixels_in, pixel_data_size);
  cudaMalloc((void**) &device_pixels_out, pixel_data_size);
  cudaMemcpy(device_pixels_in, im.data, pixel_data_size, cudaMemcpyHostToDevice);

  int dimx = ceil(((float)im.width) / T);
  int dimy = ceil(((float)im.height) / T);
  dim3 block(T, T, 1), grid(dimx, dimy, 1);

  timer time;  
  blur<<<grid, block>>>(device_pixels_in, device_pixels_out, im.width, im.height);
  cudaDeviceSynchronize();
  cout << "Elapsed time: " << time.getTime() << endl;    

  cudaMemcpy(im.data, device_pixels_out, pixel_data_size, cudaMemcpyDeviceToHost);
  
  bmp.set_pixel_data(im);
  bmp.save("output.bmp");
}
